const axios = require('axios');
const crypto = require('crypto');
const constants = require('../configs/constants');

client.setConfig({
  apiKey: constants.MAILCHIMP_API_KEY,
  server: "us21",
});

const audience_id="f7414bef02"

const addOrUpdateToContact=async({email, merge_fields, interests})=>{
  const subscriberHash = crypto.createHash('md5').update(email.toLowerCase()).digest('hex');
  
  await client.lists.setListMember(
    audience_id,subscriberHash,
    { email_address: email, status_if_new: "active",merge_fields, interests }
  );
}


const addUserToContactsWhenSubscribing=async({email})=>{
  try{
    await client.lists.addListMember(
      audience_id, {
      email_address:email
    })
  }
  catch (error){
    if(error?.response?.body?.title==='Member Exists'){
      return {
        status:true
      }
    }
    else{
      next(error)
    }
  }

}

const addUserToContacts=async({email, merge_fields})=>{
  await client.lists.addListMember(audience_id,
    {
        email_address: email,
        status: "active",
        merge_fields
    },
    {
      skipMergeValidation: false
    }
)}

const addUserToNewsletter=async({tagName="newsletter subscriber", email})=>{
  const subscriberHash = crypto.createHash('md5').update(email.toLowerCase()).digest('hex');
  await client.lists.updateListMemberTags(
    audience_id,subscriberHash,
    { tags: [{ name: tagName, status: "active" }] }
  );
}
const generateVisualizationPlan = async (payload) =>{
    try {
    const systemPrompt = `
        You are a data visualization assistant.  
        Given the information about a dataset (columns, description, goal, indices, sample rows, etc.), your job is to output a JSON with an array “visualizations” where each item has:
        - plot_type (e.g., bar chart, line chart, scatter plot, histogram, pie chart, box plot, heatmap, area chart, bubble chart, violin plot, radar chart, etc. for more than one suggestion, separate with comma(not more than 2) in order of preference)
        - title (a short, descriptive title for the visualization)
        - description (a brief explanation of what the visualization shows)
        - x
        - y (or array of y’s)
        - optionally z or group_by
        - why (a short explanation)
        Return valid JSON only, no extra text. Try to suggest visualizations that best align with the user's goal and the nature of the data. Also, try to maximize as much chart variety as possible.
    `.trim();

    const userPrompt = `
    Here is the dataset info:
    Columns: ${JSON.stringify(payload.columns)}
    Description: ${payload.description}
    Goal: ${payload.goal}
    Indices: ${JSON.stringify(payload.indices)}
    Sample rows: ${JSON.stringify(payload.sample_data)}
    Categorical columns: ${JSON.stringify(payload.categorical_columns)}
    Numerical columns: ${JSON.stringify(payload.numerical_columns)}
    Date columns: ${JSON.stringify(payload.date_columns)}
    Unique columns: ${JSON.stringify(payload.unique_columns)}
    `.trim();
    const response = await openai.chat.completions.create({
        model: "gpt-4",
        messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: userPrompt }
        ],
        temperature: 0.0,
        max_tokens: 500
    });

    return response.choices[0].message.content;
    }  catch (error) {
        console.log({error})
        console.error("Error generating visualization plan:", error);
        throw error;
    }
}
module.exports= {generateVisualizationPlan, addUserToNewsletter,addOrUpdateToContact}
